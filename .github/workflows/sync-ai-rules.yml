name: Sync AI Rules to Standard YAML
on:
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Process Rules with Python
        run: |
          mkdir -p Clash/rules
          # 使用 Python 确保字符串包裹和缩进万无一失
          python3 -c "
          import urllib.request
          import datetime

          source_url = 'https://raw.githubusercontent.com/szkane/ClashRuleSet/main/Clash/Ruleset/AiDomain.list'
          try:
              with urllib.request.urlopen(source_url) as response:
                  lines = response.read().decode('utf-8').splitlines()
              
              with open('Clash/rules/AI.yaml', 'w', encoding='utf-8') as f:
                  # 写入 Blackmatrix7 风格头部
                  f.write(f'# Updated: {datetime.datetime.now().strftime(\"%Y-%m-%d %H:%M:%S\")}\n')
                  f.write('payload:\n')
                  
                  for line in lines:
                      line = line.strip()
                      if not line:
                          continue
                      if line.startswith('#'):
                          # 备注行：缩进 2 格并保留 #
                          f.write(f'  {line}\n')
                      else:
                          # 规则行：缩进 2 格，带列表符，且用单引号包裹
                          # 例如：  - 'DOMAIN-SUFFIX,openai.com'
                          f.write(f\"  - '{line}'\n\")
              print('Successfully generated AI.yaml in standard format.')
          except Exception as e:
              print(f'Error: {e}')
              exit(1)
          "

      - name: Deploy to Repo
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add Clash/rules/AI.yaml
          git diff --staged --quiet || (git commit -m "Standardize AI rules: Blackmatrix7 format" && git push)
