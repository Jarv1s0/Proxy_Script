name: Build SteamCN MRS (Pure Tool)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 22 * * *" # æ¯å¤© UTC 22:00 è‡ªåŠ¨è¿è¡Œ

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. å‡†å¤‡ Go ç¯å¢ƒ
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      # 2. å‡†å¤‡ç›®å½•
      - name: Prepare Directory
        run: mkdir -p Clash/rule-set

      # 3. ä¸‹è½½ SteamCN åŸå§‹è§„åˆ™
      - name: Download SteamCN
        run: |
          curl -sL -o Clash/SteamCN.yaml https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/SteamCN/SteamCN.yaml

      # 4. ç°åœºç¼–è¯‘â€œçº¯å‡€è½¬æ¢å™¨â€ (ä¸å«ä»£ç†å¼•æ“)
      # è¿™ä¸€æ­¥ä¼šä»æºç æ„å»ºä¸€ä¸ªåªè´Ÿè´£è½¬æ¢ã€ä¸ä¼šç›‘å¬ä»»ä½•ç«¯å£çš„å°å·¥å…·
      - name: Build and Run Converter
        run: |
          # å…‹éš†å®˜æ–¹è½¬æ¢å·¥å…·æºç 
          git clone --depth 1 https://github.com/MetaCubeX/meta-rules-converter.git converter-source
          cd converter-source
          
          echo "ğŸ”¨ æ­£åœ¨ç¼–è¯‘çº¯å‡€è½¬æ¢å·¥å…·..."
          go build -o ../pure-converter .
          cd ..
          
          echo "ğŸ”„ æ­£åœ¨æ‰§è¡Œè½¬æ¢ (SteamCN)..."
          # è¯­æ³•ï¼š./pure-converter <ç±»å‹> <æ ¼å¼> <æºæ–‡ä»¶> <ç›®æ ‡æ–‡ä»¶>
          # è¿™ä¸ªå·¥å…·æ²¡æœ‰ 'convert-ruleset' å…³é”®å­—ï¼Œä¹Ÿæ²¡æœ‰ä»£ç†é€»è¾‘
          ./pure-converter classical yaml Clash/SteamCN.yaml Clash/rule-set/SteamCN.mrs
          
          echo "âœ… è½¬æ¢å®Œæˆï¼Œæ¸…ç†æºç ..."
          rm -rf converter-source pure-converter

      # 5. æäº¤ç”Ÿæˆçš„ MRS æ–‡ä»¶
      - name: Git Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [ -f "Clash/rule-set/SteamCN.mrs" ]; then
            git add Clash/rule-set/SteamCN.mrs
            # åªæœ‰å½“æ–‡ä»¶ç¡®å®æœ‰å˜åŒ–æ—¶æ‰æäº¤
            git diff --staged --quiet || (git commit -m "update: SteamCN.mrs [skip ci]" && git push)
            echo "ğŸš€ ä»»åŠ¡åœ†æ»¡å®Œæˆï¼"
          else
            echo "ğŸš¨ é”™è¯¯ï¼šMRS æ–‡ä»¶æœªèƒ½ç”Ÿæˆï¼"
            exit 1
          fi
