name: Build SteamCN MRS

on:
  workflow_dispatch:
  schedule:
    - cron: "0 22 * * *" # 每天 UTC 22:00 运行

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Get Pure Converter
        # 仅拉取官方转换工具源码，不含内核代理逻辑
        run: git clone --depth 1 https://github.com/MetaCubeX/meta-rules-converter.git converter

      - name: Prepare Rules
        # 确保目录存在并下载最新的 SteamCN 规则
        run: |
          mkdir -p Clash/rule-set
          curl -sL -o Clash/SteamCN.yaml https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/SteamCN/SteamCN.yaml

      - name: Convert SteamCN Only
        # 只处理 SteamCN，强制使用 classical 混合模式以保证 100% 兼容
        run: |
          cd converter
          go run . classical yaml ../Clash/SteamCN.yaml ../Clash/rule-set/SteamCN.mrs

      - name: Git Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # 仅将生成的 mrs 文件推送到远程仓库
          if [ -f "Clash/rule-set/SteamCN.mrs" ]; then
            git add Clash/rule-set/SteamCN.mrs
            git diff --staged --quiet || (git commit -m "update: SteamCN.mrs [skip ci]" && git push)
            echo "✅ Build and Push completed."
          else
            echo "❌ Error: MRS file not found."
            exit 1
          fi
