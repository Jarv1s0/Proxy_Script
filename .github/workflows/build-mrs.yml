name: Build Rules (Go Edition)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 22 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. é…ç½® Go ç¯å¢ƒ (ç…§æ¬å¤§ä½¬ä»“åº“çš„é…ç½®)
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      # 2. æ‹‰å–è½¬æ¢å·¥å…·æºç  (åªæ‹‰å–è½¬æ¢å™¨ï¼Œä¸æ‹‰å–æ•´ä¸ªå†…æ ¸)
      - name: Checkout Converter
        uses: actions/checkout@v4
        with:
          repository: MetaCubeX/meta-rules-converter
          path: converter

      # 3. å‡†å¤‡ç›®å½• & ä¸‹è½½ SteamCN è§„åˆ™
      - name: Prepare Data
        run: |
          mkdir -p Clash/rule-set
          echo "â¬‡ï¸ Downloading SteamCN..."
          curl -sL -o Clash/SteamCN.yaml https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/SteamCN/SteamCN.yaml

      # 4. ç¼–è¯‘å¹¶è¿è¡Œè½¬æ¢ (è¿™æ˜¯æ ¸å¿ƒï¼)
      # ç›´æ¥è¿è¡Œ Go ä»£ç ï¼Œæ²¡æœ‰ä¸­é—´å•†èµšå·®ä»·ï¼Œç»å¯¹ä¸ä¼šæ­»é”
      - name: Convert Rules
        run: |
          echo "ğŸ”„ Compiling and Converting..."
          cd converter
          
          # è¯­æ³•: go run . convert-ruleset <ç±»å‹> <æºæ–‡ä»¶> <ç›®æ ‡æ–‡ä»¶>
          # æ³¨æ„è·¯å¾„ï¼šå› ä¸ºè¿›åˆ°äº† converter ç›®å½•ï¼Œæ‰€ä»¥è¦ç”¨ ../ å›åˆ°ä¸Šçº§
          go run . convert-ruleset classical ../Clash/SteamCN.yaml ../Clash/rule-set/SteamCN.mrs
          
          echo "âœ… Conversion Done!"

      # 5. æäº¤ç»“æœ
      - name: Git Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f "Clash/rule-set/SteamCN.mrs" ]; then
            git add -f Clash/rule-set/*.mrs
            if ! git diff --staged --quiet; then
              git commit -m "chore: update SteamCN.mrs [skip ci]"
              git push
              echo "âœ… æ¨é€æˆåŠŸ"
            else
              echo "ğŸ’¤ æ— å˜åŒ–"
            fi
          else
            echo "âŒ è½¬æ¢å¤±è´¥ï¼Œæ–‡ä»¶æœªç”Ÿæˆ"
            exit 1
          fi
