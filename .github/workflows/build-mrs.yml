name: Build Rules (Docker Edition)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 22 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Prepare Directory & Download Rules
        run: |
          mkdir -p Clash/rule-set
          
          # ç›´æ¥ç”¨ç³»ç»Ÿè‡ªå¸¦å·¥å…·ä¸‹è½½è§„åˆ™ï¼Œä¸ä¾èµ– Python
          echo "â¬‡ï¸ Downloading SteamCN..."
          curl -sL -o Clash/SteamCN.yaml https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/SteamCN/SteamCN.yaml
          
          # éªŒè¯æ–‡ä»¶æ˜¯å¦ä¸‹è½½æˆåŠŸ
          ls -lh Clash/SteamCN.yaml

      - name: Convert via Docker
        run: |
          echo "ğŸ³ Starting Docker container to convert rules..."
          
          # ä½¿ç”¨å®˜æ–¹ Mihomo é•œåƒï¼ŒæŒ‚è½½å½“å‰ç›®å½•åˆ°å®¹å™¨å†…
          # è¿™æ ·æ— è®ºå®¿ä¸»æœºç¯å¢ƒå¦‚ä½•ï¼Œå®¹å™¨å†…ä¸€å®šæ˜¯æ ‡å‡†çš„
          docker run --rm \
            -v ${{ github.workspace }}:/workspace \
            -w /workspace \
            metacubex/mihomo:latest \
            convert-ruleset classical Clash/SteamCN.yaml Clash/rule-set/SteamCN.mrs

          echo "âœ… Conversion finished."

      - name: Check Outputs
        run: |
          if [ -f "Clash/rule-set/SteamCN.mrs" ]; then
            echo "ğŸ‰ File generated successfully:"
            ls -lh Clash/rule-set/SteamCN.mrs
          else
            echo "âŒ File not found!"
            exit 1
          fi

      - name: Git Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add -f Clash/rule-set/*.mrs
          
          if ! git diff --staged --quiet; then
            git commit -m "chore: update rules via Docker [skip ci]"
            git push
            echo "âœ… Changes pushed"
          else
            echo "ğŸ’¤ No changes detected"
          fi
