name: Build Mihomo Rule Sets

on:
  push:
    paths:
      - 'Clash/**'        # åªè¦ Clash æ–‡ä»¶å¤¹ä¸‹æœ‰å˜åŠ¨å°±è§¦å‘
      - '!Clash/rule-set/**' # (å¯é€‰) å¿½ç•¥è¾“å‡ºç›®å½•çš„å˜åŠ¨ï¼Œé˜²æ­¢å¾ªç¯è§¦å‘
  workflow_dispatch:
  schedule:
    - cron: '0 20 * * *'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install requests

      - name: Run Conversion Script
        # æ³¨æ„è¿™é‡Œè·¯å¾„çš„å˜åŒ–
        run: python -u Clash/scripts/convert.py

      - name: Commit and Push Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # æ£€æŸ¥è¾“å‡ºç›®å½•æ˜¯å¦å­˜åœ¨
          if [ -d "Clash/rule-set" ]; then
            # å¼ºåˆ¶æ·»åŠ ç”Ÿæˆçš„ mrs æ–‡ä»¶
            git add -f Clash/rule-set/*.mrs
            
            if ! git diff --cached --quiet; then
              git commit -m "chore: auto-build .mrs files [skip ci]"
              git push
              echo "âœ… å·²æ¨é€æ›´æ–°"
            else
              echo "ğŸ’¤ æ— å˜åŒ–"
            fi
          else
            echo "âš ï¸ æœªæ‰¾åˆ°è¾“å‡ºç›®å½•"
          fi
