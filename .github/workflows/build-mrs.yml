name: Build Rules (Pure Converter)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 22 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      # 1. ç›´æ¥æ‹‰å–å®˜æ–¹ä¸“é—¨çš„è½¬æ¢å™¨æºç ï¼ˆæ³¨æ„ï¼šè¿™ä¸æ˜¯å†…æ ¸ï¼Œæ²¡æœ‰ä»£ç†åŠŸèƒ½ï¼‰
      - name: Get Official Converter
        run: |
          git clone https://github.com/MetaCubeX/meta-rules-converter.git converter

      # 2. å‡†å¤‡è§„åˆ™
      - name: Prepare Rules
        run: |
          mkdir -p Clash/rule-set
          curl -sL -o Clash/SteamCN.yaml https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/SteamCN/SteamCN.yaml

      # 3. ç°åœºç¼–è¯‘å¹¶è½¬æ¢ (ä½¿ç”¨è½¬æ¢å™¨çš„åŸç”Ÿè¯­æ³•)
      # è¿™ä¸ªå·¥å…·è¿è¡Œå®Œä¼šç«‹å³é€€å‡ºï¼Œç»å¯¹ä¸ä¼šå¼€å¯ä»»ä½•ç«¯å£
      - name: Convert
        run: |
          echo "ğŸ”„ Converting via standalone tool..."
          cd converter
          # è½¬æ¢å™¨è¯­æ³•ï¼šgo run . [ç±»å‹] [æ ¼å¼] [è¾“å…¥è·¯å¾„] [è¾“å‡ºè·¯å¾„]
          go run . classical yaml ../Clash/SteamCN.yaml ../Clash/rule-set/SteamCN.mrs
          
          # å¤„ç†ä½  Clash ç›®å½•ä¸‹çš„å…¶ä»– yaml
          for file in ../Clash/*.yaml; do
            if [[ "$file" == *"SteamCN.yaml" ]]; then continue; fi
            name=$(basename "$file" .yaml)
            go run . classical yaml "$file" "../Clash/rule-set/$name.mrs"
          done

      # 4. æäº¤æ›´æ–°
      - name: Push Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [ -d "Clash/rule-set" ]; then
            git add -f Clash/rule-set/*.mrs
            if ! git diff --staged --quiet; then
              git commit -m "chore: auto-build .mrs rules [skip ci]"
              git push
            else
              echo "No changes."
            fi
          fi
