name: Build Steam Rules

on:
  workflow_dispatch:
  schedule:
    - cron: "0 22 * * *"

jobs:
  build-and-convert:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. å‡†å¤‡ Go ç¯å¢ƒï¼ˆè½¬æ¢å·¥å…·æ˜¯ç”¨ Go å†™çš„ï¼‰
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.22"

      # 2. æ‹‰å–å®˜æ–¹ä¸“é—¨çš„è½¬æ¢å·¥å…·æºç  (MetaCubeX å®˜æ–¹å‡ºå“)
      - name: Get Converter Tool
        run: |
          git clone https://github.com/MetaCubeX/meta-rules-converter.git converter
          cd converter
          # ç°åœºç¼–è¯‘å‡ºè½¬æ¢å·¥å…·ï¼Œç¡®ä¿å®ƒæ˜¯ä¸€ä¸ªâ€œåªä¼šè½¬æ¢â€çš„çº¯å‡€ç¨‹åº
          go build -o ../rules-converter .

      # 3. å‡†å¤‡è§„åˆ™ç›®å½•å¹¶ä¸‹è½½ SteamCN
      - name: Download SteamCN Rule
        run: |
          mkdir -p Clash/rule-set
          curl -sL -o Clash/SteamCN.yaml https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/SteamCN/SteamCN.yaml

      # 4. æ‰§è¡Œè½¬æ¢ï¼ˆå…³é”®ï¼šä¸å†è°ƒç”¨ mihomo convert-rulesetï¼Œè€Œæ˜¯ç›´æ¥ç”¨è½¬æ¢å™¨ï¼‰
      - name: Pure Conversion
        run: |
          echo "ğŸ”„ Converting via dedicated tool..."
          
          # è¯­æ³•ï¼š./rules-converter <å­å‘½ä»¤> <ç±»å‹> <æ ¼å¼> <æºæ–‡ä»¶> <ç›®æ ‡æ–‡ä»¶>
          # è¿™æ ·è°ƒç”¨ç»å¯¹ä¸ä¼šè§¦å‘â€œProxy Listeningâ€ï¼
          ./rules-converter convert-ruleset classical yaml Clash/SteamCN.yaml Clash/rule-set/SteamCN.mrs
          
          # åŒæ—¶ä¹Ÿå¤„ç†ä½  Clash ç›®å½•ä¸‹å…¶ä»–çš„ yaml æ–‡ä»¶
          for file in Clash/*.yaml; do
            if [[ "$file" == *"SteamCN.yaml" ]]; then continue; fi
            name=$(basename "$file" .yaml)
            ./rules-converter convert-ruleset classical yaml "$file" "Clash/rule-set/$name.mrs"
          done

      # 5. æ¨é€ MRS æ–‡ä»¶åˆ°ä»“åº“
      - name: Push to Repository
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [ -d "Clash/rule-set" ]; then
            git add -f Clash/rule-set/*.mrs
            if ! git diff --staged --quiet; then
              git commit -m "chore: auto-convert rulesets [skip ci]"
              git push
            else
              echo "No changes to push."
            fi
          fi
