name: Build Rules (Shell Edition)

on:
  workflow_dispatch: # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 22 * * *' # æ¯å¤©æ—©æ™¨6ç‚¹è‡ªåŠ¨æ›´æ–° (UTC 22:00)

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Prepare Environment
        run: |
          # 1. åˆ›å»ºç›®å½•
          mkdir -p Clash/rule-set
          
          # 2. ä¸‹è½½ Mihomo å†…æ ¸ (ä½¿ç”¨ v1.17 ç¨³å®šç‰ˆ)
          echo "â¬‡ï¸ Downloading Mihomo..."
          wget -q -O mihomo.gz https://github.com/MetaCubeX/mihomo/releases/download/v1.17.0/mihomo-linux-amd64-v1.17.0.gz
          gunzip mihomo.gz
          chmod +x mihomo
          
          # 3. ä¸‹è½½ SteamCN è§„åˆ™ (ç›´æ¥ä¸‹è½½åˆ° Clash ç›®å½•)
          echo "â¬‡ï¸ Downloading SteamCN..."
          wget -q -O Clash/SteamCN.yaml https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/SteamCN/SteamCN.yaml
          
          # æ£€æŸ¥æ–‡ä»¶å¤´ï¼Œé˜²æ­¢ 404
          head -n 5 Clash/SteamCN.yaml

      - name: Convert Rules
        run: |
          echo "ğŸ”„ Converting..."
          
          # ç›´æ¥åœ¨ Shell é‡Œè°ƒç”¨ï¼Œç»å¯¹ä¸ä¼šæ­»é”
          # è¯­æ³•: ./mihomo convert-ruleset <ç±»å‹> <æº> <ç›®æ ‡>
          
          # 1. è½¬æ¢ SteamCN (ä½¿ç”¨ classical æ··åˆæ¨¡å¼)
          ./mihomo convert-ruleset classical Clash/SteamCN.yaml Clash/rule-set/SteamCN.mrs
          
          # 2. (å¯é€‰) æ‰«æ Clash ç›®å½•ä¸‹å…¶ä»–æœ¬åœ° yaml æ–‡ä»¶å¹¶è½¬æ¢
          for file in Clash/*.yaml; do
            # è·³è¿‡ SteamCN (å› ä¸ºä¸Šé¢å·²ç»è½¬è¿‡äº†)
            if [ "$file" == "Clash/SteamCN.yaml" ]; then continue; fi
            
            filename=$(basename "$file" .yaml)
            echo "Processing $filename ..."
            ./mihomo convert-ruleset classical "$file" "Clash/rule-set/$filename.mrs"
          done

      - name: Check Artifacts
        run: |
          ls -lh Clash/rule-set/

      - name: Git Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          git add -f Clash/rule-set/*.mrs
          
          if ! git diff --staged --quiet; then
            git commit -m "chore: update rules $(date +'%Y-%m-%d') [skip ci]"
            git push
            echo "âœ… Push success"
          else
            echo "ğŸ’¤ No changes"
          fi
