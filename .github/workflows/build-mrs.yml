name: Build Rules (Final Correction)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 22 * * *'

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'

      - name: Get Converter
        run: |
          # ä»…æ‹‰å–è½¬æ¢å·¥å…·æºç 
          git clone https://github.com/MetaCubeX/meta-rules-converter.git converter

      - name: Prepare Rules
        run: |
          mkdir -p Clash/rule-set
          # ä¸‹è½½åŸå§‹ YAML
          curl -sL -o Clash/SteamCN.yaml https://raw.githubusercontent.com/blackmatrix7/ios_rule_script/master/rule/Clash/SteamCN/SteamCN.yaml

      - name: Pure Conversion
        run: |
          echo "ğŸ”„ Using pure converter (No mihomo core)..."
          cd converter
          
          # ã€æ ¸å¿ƒä¿®æ”¹ã€‘ï¼šå»æ‰ convert-ruleset å…³é”®å­—
          # è½¬æ¢å™¨åŸç”Ÿå‚æ•°é¡ºåºï¼šç±»å‹(classical) æ ¼å¼(yaml) è¾“å…¥ è·¯å¾„
          go run . classical yaml ../Clash/SteamCN.yaml ../Clash/rule-set/SteamCN.mrs
          
          echo "âœ… Done."

      - name: Git Push
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [ -f "Clash/rule-set/SteamCN.mrs" ]; then
            git add -f Clash/rule-set/*.mrs
            if ! git diff --staged --quiet; then
              git commit -m "chore: auto-build .mrs [skip ci]"
              git push
            else
              echo "No changes."
            fi
          else
            echo "Error: MRS file not generated."
            exit 1
          fi
